{% extends "base.html" %}

{% block title %} — Donor Dashboard{% endblock %}

{% block content %}
<style>
    dialog.modal {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        margin: 0 !important;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 9999 !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
    }

    dialog.modal::backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 9998 !important;
    }

    .modal-backdrop {
        z-index: 9998 !important;
    }

    .modal-box {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border-radius: 1.5rem !important;
    }
</style>

<div class="min-h-screen bg-base-200/20 py-10 relative">
    <img src="/static/img/shareLine-logo.png" alt="ShareLine Logo Background"
        class="fixed inset-0 w-full h-full object-contain opacity-10 pointer-events-none z-0" />

    <div class="relative z-10 flex justify-center items-start px-4">
        <div class="w-full max-w-6xl">
            <div class="card w-full bg-base-100/95 backdrop-blur-sm shadow-xl rounded-2xl">
                <div class="card-body space-y-6 p-8">
                    <div>
                        <h2 class="card-title text-3xl font-bold mb-2">
                            Welcome, {{ current_user.name }}!
                        </h2>
                        <p class="text-sm leading-relaxed text-base-content/70">
                            Thank you for being a donor on ShareLine. Here you can manage the items you've
                            shared and add new donations to support affected students across campus.
                        </p>
                    </div>

                    <div class="divider"></div>

                    <div class="flex justify-between items-center gap-4">
                        <div>
                            <h3 class="text-lg font-semibold">
                                Donate a new item
                            </h3>
                            <p class="text-xs text-base-content/70">
                                List a new item so affected students can find and request it.
                            </p>
                        </div>
                        <button
                            class="btn btn-primary"
                            onclick="openDonateModal()"
                            hx-get="/ui/donor/donate-form"
                            hx-target="#donate-form-container"
                            hx-swap="innerHTML">
                            + Donate an Item
                        </button>
                    </div>

                    <div class="divider"></div>

                    <div id="my-items-section">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <h3 class="text-lg font-semibold mb-2">
                                    My Items
                                </h3>
                                <p class="text-xs text-base-content/70">
                                    These are the items you've listed as available on ShareLine.
                                </p>
                            </div>
                            <button
                                class="btn btn-sm btn-outline"
                                hx-get="/ui/donor/items"
                                hx-target="#donor-items-list"
                                hx-swap="outerHTML">
                                Refresh My Items
                            </button>
                        </div>

                        <div id="donor-items-list"
                             class="mt-4"
                             hx-get="/ui/donor/items"
                             hx-trigger="load, donor-items-refresh from:body"
                             hx-target="this"
                             hx-swap="outerHTML">
                            <div class="text-center py-6 text-base-content/60">
                                <span class="loading loading-spinner loading-lg mb-2"></span>
                                <p>Loading your items…</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Donate Item Modal -->
<div
    id="donate-modal"
    class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-20 hidden"
    onclick="if (event.target === this) { closeDonateModal(); }">
    <div class="card bg-base-100 w-full max-w-sm shadow-2xl rounded-2xl">
        <div id="donate-form-container"
             hx-get="/ui/donor/donate-form"
             hx-trigger="load, refresh-donate-form from:body"
             hx-target="this"
             hx-swap="innerHTML">
            <div class="card-body p-8 text-center text-base-content/70">
                <span class="loading loading-spinner loading-lg mb-4"></span>
                <p>Loading form…</p>
            </div>
        </div>
    </div>
</div>

<!-- Requests Modal -->
<dialog id="requests-modal" class="modal">
    <div class="modal-box bg-base-100 max-w-2xl w-full p-8">
        <div id="requests-modal-content" class="py-12 text-center text-base-content/70">
            <span class="loading loading-spinner loading-lg mb-3"></span>
            <p>Select an item to view its requests.</p>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop bg-black/60">
        <button type="button" onclick="closeRequestsModal()">close</button>
    </form>
</dialog>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const donateModal = document.getElementById('donate-modal');
        const donateFormContainer = document.getElementById('donate-form-container');
        const requestsModal = document.getElementById('requests-modal');
        const requestsContent = document.getElementById('requests-modal-content');
        const requestsLoadingTemplate = `
            <div class="py-12 text-center text-base-content/70">
                <span class="loading loading-spinner loading-lg mb-3"></span>
                <p>Loading requests…</p>
            </div>
        `;

        window.openDonateModal = function () {
            if (!donateModal) return;
            donateModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeDonateModal = function () {
            if (!donateModal) return;
            donateModal.classList.add('hidden');
            document.body.style.overflow = '';
        };

        window.openRequestsModal = function () {
            if (!requestsModal) return;
            if (requestsContent) {
                requestsContent.innerHTML = requestsLoadingTemplate;
            }
            if (!requestsModal.open) {
                requestsModal.showModal();
            }
        };

        window.closeRequestsModal = function () {
            if (requestsModal && requestsModal.open) {
                requestsModal.close();
            }
        };

        document.body.addEventListener('close-donate-modal', () => {
            closeDonateModal();
            document.body.dispatchEvent(new Event('refresh-donate-form'));
        });
    });
</script>
{% endblock %}
