<!DOCTYPE html>
<html lang="en" data-theme="winter">

<head>
    <meta charset="UTF-8">
    <title>ShareLine{% block title %}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind + DaisyUI compiled CSS -->
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        // Alpine.js global utilities and components
        document.addEventListener('alpine:init', () => {
            // Utility function for API calls
            Alpine.store('api', {
                async fetch(url, options = {}) {
                    const defaultOptions = {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    };
                    const response = await fetch(url, defaultOptions);
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ detail: 'Request failed' }));
                        throw new Error(error.detail || `HTTP ${response.status}`);
                    }
                    const contentLength = response.headers.get('content-length');
                    const contentType = response.headers.get('content-type') || '';

                    if (response.status === 204 || contentLength === '0' || !contentType) {
                        return null;
                    }

                    if (contentType.includes('application/json')) {
                        return response.json();
                    }

                    return null;
                }
            });

            // Items loader component
            Alpine.data('itemsLoader', (apiUrl) => ({
                items: [],
                loading: false,
                error: null,
                async init() {
                    await this.loadItems();
                },
                async loadItems() {
                    this.loading = true;
                    this.error = null;
                    try {
                        this.items = await Alpine.store('api').fetch(apiUrl);
                    } catch (error) {
                        this.error = error.message;
                        console.error('Error loading items:', error);
                    } finally {
                        this.loading = false;
                    }
                }
            }));

            // Request item component
            Alpine.store('requestItem', {
                showModal: false,
                item: null,
                quantity: 1,
                loading: false,
                error: null,
                open(item) {
                    this.item = item;
                    this.quantity = 1;
                    this.showModal = true;
                    this.error = null;
                },
                close() {
                    this.showModal = false;
                    this.item = null;
                    this.quantity = 1;
                    this.error = null;
                },
                async submit() {
                    if (!this.item || this.quantity <= 0 || this.quantity > this.item.quantity) {
                        this.error = 'Invalid quantity';
                        return;
                    }
                    if (!window.currentUser) {
                        this.error = 'Please log in to make a request';
                        return;
                    }
                    this.loading = true;
                    this.error = null;
                    try {
                        const requestData = {
                            requester_id: window.currentUser.id,
                            item_id: this.item.id,
                            requested_quantity: this.quantity
                        };
                        await Alpine.store('api').fetch('/requests/', {
                            method: 'POST',
                            body: JSON.stringify(requestData)
                        });
                        this.close();
                        window.dispatchEvent(new CustomEvent('items-updated'));
                        alert('Request submitted successfully!');
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                }
            });
        });
    </script>
</head>

<body class="min-h-screen bg-base-200">
    {% if current_user %}
    <script>
        window.currentUser = {
            id: {{ current_user.id }},
            name: "{{ current_user.name }}",
            email: "{{ current_user.email }}",
            role: "{{ current_role }}"
        };
    </script>
    {% endif %}

    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-sm sticky top-0 z-50">
        <div class="navbar-start">
            <img src="/static/img/shareLine-logo.png" alt="ShareLine Logo" class="w-10 h-10 mr-2">
            <a class="btn btn-ghost text-xl" href="/">ShareLine</a>
        </div>

        <div class="navbar-end">
            <div class="flex items-center space-x-3">
                {% if current_user %}
                <span class="px-2">Hello, {{ current_user.name }}</span>
                <form method="post" action="/logout" class="m-0">
                    <button type="submit" class="btn btn-error">Log out</button>
                </form>
                {% else %}
                <a class="btn btn-error" href="/login">Log in</a>
                <a class="btn btn-outline" href="/register">Register</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main content -->
    <main class="relative">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t mt-8">
        <aside>
            <p>© 2025 ShareLine · Built for COMPSCI 326 Web Programming</p>
        </aside>
    </footer>

</body>

</html>
